<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Gesture Handler Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .console {
            background: #2d3748;
            color: #e2e8f0;
            border: 1px solid #4a5568;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h1>User Gesture Handler Test</h1>
    <p>This page tests the user gesture detection functionality that was added to the content script.</p>

    <div class="test-section">
        <h2>Test Setup</h2>
        <button onclick="setupTestEnvironment()">Setup Test Environment</button>
        <div id="setupStatus" class="status info">Click to setup test environment</div>
    </div>

    <div class="test-section">
        <h2>Test 1: Simulate Suspended AudioContext</h2>
        <button onclick="simulateSuspendedContext()">Create Suspended AudioContext</button>
        <button onclick="checkContextState()">Check AudioContext State</button>
        <div id="contextState" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Trigger User Gestures</h2>
        <p>Click anywhere on this page or press any key to trigger gesture detection</p>
        <button onclick="simulateClick()">Simulate Click Programmatically</button>
        <button onclick="simulateKeypress()">Simulate Keypress Programmatically</button>
        <div id="gestureStatus" class="status info">Waiting for user gesture...</div>
    </div>

    <div class="test-section">
        <h2>Test 3: Test Audio Playback</h2>
        <button onclick="testAudioPlayback()">Test Audio Playback</button>
        <div id="audioTestStatus" class="status"></div>
    </div>

    <div class="test-section">
        <h2>Console Output</h2>
        <div id="consoleOutput" class="console"></div>
    </div>

    <script>
        // Mock chrome storage for testing
        const mockChrome = {
            storage: {
                sync: {
                    get: function(keys, callback) {
                        const data = {
                            enabled: true,
                            mode: "alarm_only",
                            refreshInterval: 5,
                            alertSoundType: "default",
                            showTestButton: true,
                            enableDesktopNotifications: true
                        };
                        callback(data);
                    },
                    set: function(data, callback) {
                        if (callback) callback();
                    }
                },
                local: {
                    get: function(keys, callback) {
                        callback({});
                    }
                },
                onChanged: {
                    addListener: function() {}
                }
            },
            runtime: {
                onMessage: {
                    addListener: function() {}
                },
                getURL: function(path) {
                    return `chrome-extension://test/${path}`;
                }
            }
        };

        // Override console.log to capture output
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            logToConsole('LOG', args);
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            logToConsole('ERROR', args);
        };

        function logToConsole(level, args) {
            const consoleOutput = document.getElementById('consoleOutput');
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            
            const logEntry = document.createElement('div');
            logEntry.style.color = level === 'ERROR' ? '#f56565' : '#e2e8f0';
            logEntry.style.marginBottom = '5px';
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${level}: ${message}`;
            
            consoleOutput.appendChild(logEntry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        let testAudioContext = null;
        let gestureHandlerAdded = false;

        function setupTestEnvironment() {
            // Set up the global chrome object for testing
            window.chrome = mockChrome;
            
            // Set the loaded flag to prevent multiple injection
            window.raterHubMonitorLoaded = false;
            
            document.getElementById('setupStatus').className = 'status success';
            document.getElementById('setupStatus').innerHTML = 
                'Test environment setup complete. Chrome API mocked.';
            
            console.log('Test environment setup complete');
        }

        function simulateSuspendedContext() {
            try {
                // Create AudioContext (it will be suspended by default in some browsers)
                testAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                window.raterHubAudioContext = testAudioContext;
                
                document.getElementById('contextState').className = 'status info';
                document.getElementById('contextState').innerHTML = 
                    `AudioContext created. State: <strong>${testAudioContext.state}</strong>`;
                
                console.log(`AudioContext created with state: ${testAudioContext.state}`);
                
            } catch (error) {
                document.getElementById('contextState').className = 'status error';
                document.getElementById('contextState').innerHTML = 
                    `Error creating AudioContext: ${error.message}`;
                console.error('Error creating AudioContext:', error);
            }
        }

        function checkContextState() {
            if (window.raterHubAudioContext) {
                document.getElementById('contextState').className = 'status info';
                document.getElementById('contextState').innerHTML = 
                    `AudioContext state: <strong>${window.raterHubAudioContext.state}</strong>`;
            } else {
                document.getElementById('contextState').className = 'status warning';
                document.getElementById('contextState').innerHTML = 
                    'No AudioContext found. Create one first.';
            }
        }

        function simulateClick() {
            console.log('Simulating programmatic click...');
            const event = new MouseEvent('click', {
                view: window,
                bubbles: true,
                cancelable: true
            });
            document.dispatchEvent(event);
        }

        function simulateKeypress() {
            console.log('Simulating programmatic keypress...');
            const event = new KeyboardEvent('keydown', {
                key: ' ',
                code: 'Space',
                keyCode: 32,
                which: 32,
                bubbles: true,
                cancelable: true
            });
            document.dispatchEvent(event);
        }

        function testAudioPlayback() {
            if (!window.raterHubAudioContext) {
                document.getElementById('audioTestStatus').className = 'status warning';
                document.getElementById('audioTestStatus').innerHTML = 
                    'Please create AudioContext first';
                return;
            }

            try {
                const oscillator = window.raterHubAudioContext.createOscillator();
                const gainNode = window.raterHubAudioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(window.raterHubAudioContext.destination);

                oscillator.frequency.setValueAtTime(440, window.raterHubAudioContext.currentTime);
                oscillator.type = "sine";

                gainNode.gain.setValueAtTime(0.1, window.raterHubAudioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, window.raterHubAudioContext.currentTime + 0.3);

                oscillator.start(window.raterHubAudioContext.currentTime);
                oscillator.stop(window.raterHubAudioContext.currentTime + 0.3);

                document.getElementById('audioTestStatus').className = 'status success';
                document.getElementById('audioTestStatus').innerHTML = 
                    'Test sound played successfully!';
                console.log('Test sound played successfully');
                
            } catch (error) {
                document.getElementById('audioTestStatus').className = 'status error';
                document.getElementById('audioTestStatus').innerHTML = 
                    `Error playing sound: ${error.message}`;
                console.error('Error playing test sound:', error);
            }
        }

        // Add the user gesture handler function from content.js
        function addUserGestureHandler() {
            if (gestureHandlerAdded) return;
            
            console.log("Adding user gesture handler...");
            
            // Add a global click handler to initialize audio context on user interaction
            document.addEventListener('click', function initializeAudioOnGesture() {
                console.log("User gesture detected (click), initializing audio context if needed");
                
                // Check if we have an audio context that needs initialization
                if (window.raterHubAudioContext && window.raterHubAudioContext.state === 'suspended') {
                    window.raterHubAudioContext.resume().then(() => {
                        console.log("AudioContext resumed successfully after user gesture");
                        updateGestureStatus('Click detected! AudioContext resumed successfully.');
                    }).catch(error => {
                        console.error("Failed to resume AudioContext after user gesture:", error);
                        updateGestureStatus('Click detected! Failed to resume AudioContext: ' + error.message, 'error');
                    });
                } else {
                    console.log("AudioContext not suspended or not found");
                    updateGestureStatus('Click detected! AudioContext not suspended.');
                }
                
                // Remove the event listener after first successful interaction
                document.removeEventListener('click', initializeAudioOnGesture);
            }, { once: true, capture: true });
            
            // Also listen for keypress events for broader gesture detection
            document.addEventListener('keydown', function initializeAudioOnKeypress() {
                console.log("User gesture detected (keypress), initializing audio context if needed");
                
                if (window.raterHubAudioContext && window.raterHubAudioContext.state === 'suspended') {
                    window.raterHubAudioContext.resume().then(() => {
                        console.log("AudioContext resumed successfully after keypress");
                        updateGestureStatus('Keypress detected! AudioContext resumed successfully.');
                    }).catch(error => {
                        console.error("Failed to resume AudioContext after keypress:", error);
                        updateGestureStatus('Keypress detected! Failed to resume AudioContext: ' + error.message, 'error');
                    });
                } else {
                    console.log("AudioContext not suspended or not found");
                    updateGestureStatus('Keypress detected! AudioContext not suspended.');
                }
                
                document.removeEventListener('keydown', initializeAudioOnKeypress);
            }, { once: true, capture: true });
            
            gestureHandlerAdded = true;
            console.log("User gesture handler added successfully");
        }

        function updateGestureStatus(message, type = 'success') {
            const statusDiv = document.getElementById('gestureStatus');
            statusDiv.className = `status ${type}`;
            statusDiv.innerHTML = message;
        }

        // Initialize the test
        window.addEventListener('load', function() {
            console.log('Test page loaded');
            addUserGestureHandler();
        });
    </script>
</body>
</html>
