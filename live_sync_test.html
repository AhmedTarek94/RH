<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHAT Live Sync Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .test-section {
            background: rgba(255, 255, 255, 0.15);
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .test-button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .test-button:active {
            transform: translateY(0);
        }
        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        .success {
            background: linear-gradient(45deg, #00b894, #00a085);
            border: 2px solid #00b894;
        }
        .error {
            background: linear-gradient(45deg, #ff7675, #e17055);
            border: 2px solid #ff7675;
        }
        .info {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            border: 2px solid #74b9ff;
        }
        .log {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid;
        }
        .log-info { border-left-color: #74b9ff; }
        .log-success { border-left-color: #00b894; }
        .log-error { border-left-color: #ff7675; }
        .log-warning { border-left-color: #fdcb6e; }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #00b894, #00a085);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .test-result {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .result-icon {
            font-size: 1.5em;
            width: 30px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ RHAT Real-time Sync Live Test</h1>
        
        <div class="test-section">
            <h2>üß™ Test Suite</h2>
            <div class="test-grid">
                <button class="test-button" onclick="runThemeSyncTest()">Test Theme Synchronization</button>
                <button class="test-button" onclick="runSettingsSyncTest()">Test Settings Synchronization</button>
                <button class="test-button" onclick="runMessagePassingTest()">Test Message Passing</button>
                <button class="test-button" onclick="runPerformanceTest()">Test Performance</button>
                <button class="test-button" onclick="runErrorHandlingTest()">Test Error Handling</button>
                <button class="test-button" onclick="runAllTests()">Run All Tests</button>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="testProgress"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>üìä Test Results</h2>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>üìù Live Log</h2>
            <div id="testLog" class="log"></div>
        </div>

        <div class="test-section">
            <h2>‚öôÔ∏è Manual Testing</h2>
            <div class="test-grid">
                <button class="test-button" onclick="simulateThemeChange()">Simulate Theme Change</button>
                <button class="test-button" onclick="simulateSettingChange()">Simulate Setting Change</button>
                <button class="test-button" onclick="clearLog()">Clear Log</button>
            </div>
        </div>
    </div>

    <script>
        let testCount = 0;
        let passedTests = 0;
        const testLog = document.getElementById('testLog');
        const testResults = document.getElementById('testResults');
        const progressFill = document.getElementById('testProgress');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            testLog.appendChild(logEntry);
            testLog.scrollTop = testLog.scrollHeight;
        }
        
        function updateProgress() {
            const progress = testCount > 0 ? (passedTests / testCount) * 100 : 0;
            progressFill.style.width = `${progress}%`;
        }
        
        function addTestResult(name, success, message) {
            testCount++;
            if (success) passedTests++;
            
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result';
            resultDiv.innerHTML = `
                <span class="result-icon">${success ? '‚úÖ' : '‚ùå'}</span>
                <span><strong>${name}:</strong> ${message}</span>
            `;
            testResults.appendChild(resultDiv);
            updateProgress();
            
            log(`${success ? 'PASS' : 'FAIL'} - ${name}: ${message}`, success ? 'success' : 'error');
        }
        
        async function runThemeSyncTest() {
            log('Starting Theme Synchronization Test...', 'info');
            
            try {
                // Test theme storage
                const currentTheme = Math.random() > 0.5;
                await chrome.storage.sync.set({ darkThemeEnabled: currentTheme });
                
                // Verify storage
                const stored = await chrome.storage.sync.get(['darkThemeEnabled']);
                if (stored.darkThemeEnabled === currentTheme) {
                    addTestResult('Theme Storage', true, 'Theme stored correctly');
                } else {
                    addTestResult('Theme Storage', false, 'Theme storage failed');
                }
                
                // Test change detection
                const newTheme = !currentTheme;
                await chrome.storage.sync.set({ darkThemeEnabled: newTheme });
                
                setTimeout(async () => {
                    const updated = await chrome.storage.sync.get(['darkThemeEnabled']);
                    if (updated.darkThemeEnabled === newTheme) {
                        addTestResult('Theme Change Detection', true, 'Theme changes detected');
                    } else {
                        addTestResult('Theme Change Detection', false, 'Theme change detection failed');
                    }
                }, 100);
                
            } catch (error) {
                addTestResult('Theme Sync', false, `Error: ${error.message}`);
            }
        }
        
        async function runSettingsSyncTest() {
            log('Starting Settings Synchronization Test...', 'info');
            
            try {
                const testSettings = {
                    enabled: true,
                    mode: 'alarm_and_click',
                    refreshInterval: 5,
                    showTestButton: true
                };
                
                // Set multiple settings
                await chrome.storage.sync.set(testSettings);
                
                // Verify all settings
                const stored = await chrome.storage.sync.get(Object.keys(testSettings));
                let allMatch = true;
                
                for (const [key, value] of Object.entries(testSettings)) {
                    if (stored[key] !== value) {
                        allMatch = false;
                        break;
                    }
                }
                
                if (allMatch) {
                    addTestResult('Settings Sync', true, 'All settings synchronized');
                } else {
                    addTestResult('Settings Sync', false, 'Settings synchronization failed');
                }
                
            } catch (error) {
                addTestResult('Settings Sync', false, `Error: ${error.message}`);
            }
        }
        
        async function runMessagePassingTest() {
            log('Starting Message Passing Test...', 'info');
            
            try {
                // Test message sending
                const testMessage = {
                    action: 'testMessage',
                    timestamp: Date.now(),
                    data: 'test'
                };
                
                const response = await chrome.runtime.sendMessage(testMessage);
                
                if (response === true) {
                    addTestResult('Message Passing', true, 'Messages delivered successfully');
                } else {
                    addTestResult('Message Passing', false, 'Message delivery failed');
                }
                
            } catch (error) {
                addTestResult('Message Passing', false, `Error: ${error.message}`);
            }
        }
        
        async function runPerformanceTest() {
            log('Starting Performance Test...', 'info');
            
            try {
                const startTime = performance.now();
                const iterations = 10;
                
                for (let i = 0; i < iterations; i++) {
                    await chrome.storage.sync.set({ testPerf: i });
                }
                
                const endTime = performance.now();
                const duration = endTime - startTime;
                const avgTime = duration / iterations;
                
                if (avgTime < 50) {
                    addTestResult('Performance', true, `Avg: ${avgTime.toFixed(2)}ms (Excellent)`);
                } else if (avgTime < 100) {
                    addTestResult('Performance', true, `Avg: ${avgTime.toFixed(2)}ms (Good)`);
                } else {
                    addTestResult('Performance', false, `Avg: ${avgTime.toFixed(2)}ms (Slow)`);
                }
                
            } catch (error) {
                addTestResult('Performance', false, `Error: ${error.message}`);
            }
        }
        
        async function runErrorHandlingTest() {
            log('Starting Error Handling Test...', 'info');
            
            try {
                // Test with invalid data
                await chrome.storage.sync.set({ invalidSetting: undefined });
                
                // This should not crash
                addTestResult('Error Handling', true, 'Graceful error handling');
                
            } catch (error) {
                addTestResult('Error Handling', false, `Error: ${error.message}`);
            }
        }
        
        async function runAllTests() {
            log('üöÄ Starting Comprehensive Test Suite...', 'info');
            testCount = 0;
            passedTests = 0;
            testResults.innerHTML = '';
            updateProgress();
            
            await runThemeSyncTest();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            await runSettingsSyncTest();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            await runMessagePassingTest();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            await runPerformanceTest();
            await new Promise(resolve => setTimeout(resolve, 200));
            
            await runErrorHandlingTest();
            
            log(`üèÅ Test Suite Complete: ${passedTests}/${testCount} tests passed`, 
                passedTests === testCount ? 'success' : 'error');
        }
        
        function simulateThemeChange() {
            chrome.storage.sync.get(['darkThemeEnabled'], (data) => {
                const current = data.darkThemeEnabled || false;
                const newTheme = !current;
                
                chrome.storage.sync.set({ darkThemeEnabled: newTheme }, () => {
                    log(`Theme changed to: ${newTheme ? 'Dark' : 'Light'}`, 'info');
                });
            });
        }
        
        function simulateSettingChange() {
            const settings = ['enabled', 'mode', 'refreshInterval', 'showTestButton'];
            const randomSetting = settings[Math.floor(Math.random() * settings.length)];
            let randomValue;
            
            switch (randomSetting) {
                case 'enabled':
                case 'showTestButton':
                    randomValue = Math.random() > 0.5;
                    break;
                case 'mode':
                    randomValue = Math.random() > 0.5 ? 'alarm_only' : 'alarm_and_click';
                    break;
                case 'refreshInterval':
                    randomValue = [0.5, 1, 2, 5, 10, 30, 60][Math.floor(Math.random() * 7)];
                    break;
            }
            
            const update = {};
            update[randomSetting] = randomValue;
            
            chrome.storage.sync.set(update, () => {
                log(`Setting changed: ${randomSetting} = ${randomValue}`, 'info');
            });
        }
        
        function clearLog() {
            testLog.innerHTML = '';
            log('Log cleared', 'info');
        }
        
        // Listen for storage changes
        chrome.storage.onChanged.addListener((changes, namespace) => {
            if (namespace === 'sync') {
                Object.entries(changes).forEach(([key, change]) => {
                    log(`Storage changed: ${key} = ${change.newValue} (from: ${change.oldValue})`, 'info');
                });
            }
        });
        
        // Listen for runtime messages
        chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
            log(`Message received: ${JSON.stringify(message)}`, 'info');
            sendResponse(true);
            return true;
        });
        
        log('üß™ Live Test Environment Ready', 'success');
        log('Click test buttons to verify real-time synchronization', 'info');
    </script>
</body>
</html>
