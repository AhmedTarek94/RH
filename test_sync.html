<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RHAT Sync Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        button { margin: 5px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .status { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>RHAT Real-time Sync Test</h1>
    
    <div class="test-section">
        <h2>Test 1: Storage Change Detection</h2>
        <button onclick="testStorageChange()">Simulate Storage Change</button>
        <div id="storageTestResult" class="status">Not tested yet</div>
    </div>

    <div class="test-section">
        <h2>Test 2: Message Passing</h2>
        <button onclick="testMessagePassing()">Send Test Message</button>
        <div id="messageTestResult" class="status">Not tested yet</div>
    </div>

    <div class="test-section">
        <h2>Test 3: Settings Synchronization</h2>
        <button onclick="testSettingsSync()">Test Settings Sync</button>
        <div id="syncTestResult" class="status">Not tested yet</div>
    </div>

    <script>
        // Test 1: Storage Change Detection
        function testStorageChange() {
            const result = document.getElementById('storageTestResult');
            try {
                // Listen for storage changes
                chrome.storage.onChanged.addListener((changes, namespace) => {
                    if (namespace === 'sync' && changes.testSetting) {
                        result.innerHTML = `<span class="success">✓ Storage change detected: ${changes.testSetting.newValue}</span>`;
                    }
                });

                // Trigger a storage change
                chrome.storage.sync.set({ testSetting: 'test_value_' + Date.now() }, () => {
                    result.innerHTML = '<span class="success">✓ Storage change triggered successfully</span>';
                });
            } catch (error) {
                result.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        // Test 2: Message Passing
        function testMessagePassing() {
            const result = document.getElementById('messageTestResult');
            try {
                // Listen for messages
                chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
                    if (message.action === 'testMessage') {
                        result.innerHTML = `<span class="success">✓ Message received: ${message.data}</span>`;
                        sendResponse({ received: true });
                    }
                    return true;
                });

                // Send a test message
                chrome.runtime.sendMessage({ 
                    action: 'testMessage', 
                    data: 'Test message from options page' 
                }, (response) => {
                    if (response && response.received) {
                        result.innerHTML += '<br><span class="success">✓ Message acknowledged by receiver</span>';
                    }
                });
            } catch (error) {
                result.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }

        // Test 3: Settings Synchronization
        function testSettingsSync() {
            const result = document.getElementById('syncTestResult');
            try {
                // Simulate the notifyContentScript function
                function testNotify() {
                    chrome.runtime.sendMessage({ action: "settingsUpdated" }).catch(() => {
                        // This is expected if popup is not open
                    });
                }

                // Test that the function works
                testNotify();
                result.innerHTML = '<span class="success">✓ Settings sync notification sent successfully</span>';

            } catch (error) {
                result.innerHTML = `<span class="error">✗ Error: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>
